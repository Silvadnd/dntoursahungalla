<?php require_once '../vendor/autoload.php';require_once 'email_config.php';use PHPMailer\PHPMailer\PHPMailer;header('Content-Type: application/json');if($_SERVER['REQUEST_METHOD']==='POST'){$name=trim($_POST['name']?? '');$email=trim($_POST['email']?? '');$subject=trim($_POST['subject']?? '');$message=trim($_POST['message']?? '');if(empty($name)||empty($email)||empty($message)){echo json_encode(['success'=>false,'message'=>'Please fill in all required fields (Name, Email, Message).']);exit;}if(!filter_var($email,FILTER_VALIDATE_EMAIL)){echo json_encode(['success'=>false,'message'=>'Please enter a valid email address.']);exit;}$messagesDir='../messages/';if(!is_dir($messagesDir)){mkdir($messagesDir,0755,true);}$timestamp=date('Y-m-d_H-i-s');$filename=$messagesDir.'contact_'.$timestamp.'_'.uniqid().'.txt';$messageContent="=== CONTACT FORM SUBMISSION ===\n";$messageContent.="Date: ".date('Y-m-d H:i:s')."\n";$messageContent.="Name: ".$name."\n";$messageContent.="Email: ".$email."\n";$messageContent.="Subject: ".$subject."\n";$messageContent.="Message:\n".$message."\n";$messageContent.="IP Address: ".($_SERVER['REMOTE_ADDR']?? 'Unknown')."\n";$messageContent.="User Agent: ".($_SERVER['HTTP_USER_AGENT']?? 'Unknown')."\n";$messageContent.="================================\n\n";if(file_put_contents($filename,$messageContent)){echo json_encode(['success'=>true,'message'=>'Thank you for your message! We have received your inquiry and will get back to you soon.']);try{if(SMTP_PASSWORD!=='your_app_password_here'){$mail=new PHPMailer(false);$mail->isSMTP();$mail->Host=SMTP_HOST;$mail->SMTPAuth=true;$mail->Username=SMTP_USERNAME;$mail->Password=SMTP_PASSWORD;$mail->SMTPSecure=SMTP_SECURE==='tls'?PHPMailer::ENCRYPTION_STARTTLS:PHPMailer::ENCRYPTION_SMTPS;$mail->Port=SMTP_PORT;$mail->setFrom($email,$name);$mail->addAddress(CONTACT_EMAIL,FROM_NAME);$mail->addReplyTo($email,$name);$mail->isHTML(true);$mail->Subject=!empty($subject)?$subject:'Contact Form Submission from '.$name;$mail->Body="\n                    <h2>New Contact Form Submission</h2>\n                    <p><strong>Name:</strong> ".htmlspecialchars($name)."</p>\n                    <p><strong>Email:</strong> ".htmlspecialchars($email)."</p>\n                    <p><strong>Subject:</strong> ".htmlspecialchars($subject)."</p>\n                    <p><strong>Message:</strong></p>\n                    <p>".nl2br(htmlspecialchars($message))."</p>\n                    <p><strong>Submitted at:</strong> ".date('Y-m-d H:i:s')."</p>\n                ";$mail->send();}}catch(Exception $e){error_log("Email failed but message saved: ".$e->getMessage());}}else{echo json_encode(['success'=>false,'message'=>'Sorry, there was an error saving your message. Please try again or contact us directly at dinethrap2002@gmail.com']);}}else{echo json_encode(['success'=>false,'message'=>'Invalid request method.']);} ?>