<?php header('Content-Type: application/json');require_once 'config.php';if($_SERVER['REQUEST_METHOD']==='POST'){try{if(!$pdo){throw new Exception('Database connection failed');}$name=trim($_POST['name']?? '');$email=trim($_POST['email']?? '');$rating=intval($_POST['rating']?? 5);$reviewText=trim($_POST['reviewText']?? '');if(empty($name)||empty($reviewText)){throw new Exception('Name and review text are required');}if($rating<1||$rating>5){$rating=5;}$imageUrl=null;$tourPhotosUrls=[];if(isset($_FILES['profile_image'])&&$_FILES['profile_image']['error']===UPLOAD_ERR_OK){$uploadDir='../uploads/reviews/';if(!is_dir($uploadDir)){mkdir($uploadDir,0755,true);}$fileExtension=strtolower(pathinfo($_FILES['profile_image']['name'],PATHINFO_EXTENSION));$allowedExtensions=['jpg','jpeg','png','gif'];if(in_array($fileExtension,$allowedExtensions)){$fileName=uniqid().'.'.$fileExtension;$uploadPath=$uploadDir.$fileName;if(move_uploaded_file($_FILES['profile_image']['tmp_name'],$uploadPath)){$imageUrl='uploads/reviews/'.$fileName;}}}if(isset($_FILES['tour_photos'])&&is_array($_FILES['tour_photos']['name'])){$uploadDir='../uploads/reviews/';if(!is_dir($uploadDir)){mkdir($uploadDir,0755,true);}$allowedExtensions=['jpg','jpeg','png','gif'];for($i=0;$i<count($_FILES['tour_photos']['name']);$i++){if($_FILES['tour_photos']['error'][$i]===UPLOAD_ERR_OK){$fileExtension=strtolower(pathinfo($_FILES['tour_photos']['name'][$i],PATHINFO_EXTENSION));if(in_array($fileExtension,$allowedExtensions)){$fileName=uniqid().'_tour_'.$i.'.'.$fileExtension;$uploadPath=$uploadDir.$fileName;if(move_uploaded_file($_FILES['tour_photos']['tmp_name'][$i],$uploadPath)){$tourPhotosUrls[]='uploads/reviews/'.$fileName;}}}}}$tourPhotosJson=!empty($tourPhotosUrls)?json_encode($tourPhotosUrls):null;$stmt=$pdo->prepare("INSERT INTO reviews (name, email, rating, review_text, image_url, tour_photos) VALUES (?, ?, ?, ?, ?, ?)");$result=$stmt->execute([$name,$email,$rating,$reviewText,$imageUrl,$tourPhotosJson]);if(!$result){throw new Exception('Failed to insert review into database');}echo json_encode(['success'=>true,'message'=>'Review submitted successfully!']);}catch(Exception $e){echo json_encode(['success'=>false,'message'=>$e->getMessage(),'debug'=>['error'=>$e->getMessage(),'line'=>$e->getLine(),'file'=>$e->getFile()]]);}}else{echo json_encode(['success'=>false,'message'=>'Invalid request method']);} ?>